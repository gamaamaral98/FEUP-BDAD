.mode columns
.headers on

DROP TABLE IF EXISTS PESSOA;
DROP TABLE IF EXISTS CLIENTE;
DROP TABLE IF EXISTS PRODUTO;
DROP TABLE IF EXISTS COMPRA;
DROP TABLE IF EXISTS GESTOR;
DROP TABLE IF EXISTS FUNCIONARIO;
DROP TABLE IF EXISTS SEGURANCA;
DROP TABLE IF EXISTS OPLIMPEZA;
DROP TABLE IF EXISTS OPCAIXA;
DROP TABLE IF EXISTS GERENTE;
DROP TABLE IF EXISTS LOJA;
DROP TABLE IF EXISTS PRODUTO;
DROP TABLE IF EXISTS TIPOPRODUTO;
DROP TABLE IF EXISTS DESCONTO;
DROP TABLE IF EXISTS COMPRA;
DROP TABLE IF EXISTS FORNECEDOR;
DROP TABLE IF EXISTS CENTRODISTRIBUICAO;
DROP TABLE IF EXISTS VENDAS;
DROP TABLE IF EXISTS TRABALHAEM;
DROP TABLE IF EXISTS COMPRAEM;
DROP TABLE IF EXISTS ADQUIRE;
DROP TABLE IF EXISTS FORNECEPRODUTOS;
DROP TABLE IF EXISTS EFORNECIDA;
DROP TABLE IF EXISTS DISTRIBUI;

CREATE TABLE PESSOA (
  ID INTEGER PRIMARY KEY,
  Nome TEXT NOT NULL,
  Idade INTEGER DEFAULT 18 CHECK(Idade > 17),
  NIB INTEGER DEFAULT NULL,
  Morada TEXT(100) NOT NULL,
  Genero TEXT(1) DEFAULT "F" CHECK( Genero = "F" or Genero = "M")
);

CREATE TABLE CLIENTE (
  NrCliente INTEGER,
  Pessoa_ID INTEGER PRIMARY KEY REFERENCES PESSOA
);

CREATE TABLE GESTOR (
  Pessoa_ID INTEGER PRIMARY KEY REFERENCES PESSOA,
  Ordenado REAL CHECK (Ordenado >= 580),
  Contacto TEXT(14),
  Email TEXT(40),
  DataInicio DATE NOT NULL CHECK(DataInicio > 1910),
  DataFim DATE NOT NULL CHECK(DataFim > DataInicio)
);

CREATE TABLE FUNCIONARIO (
  Pessoa_ID INTEGER PRIMARY KEY REFERENCES PESSOA,
  Ordenado REAL CHECK (Ordenado >= 580) NOT NULL,
  RegimeTrabalho TEXT(50) NOT NULL CHECK(RegimeTrabalho = "Part Time" OR RegimeTrabalho == "Full Time"),
  DuracaoContrato INTEGER NOT NULL CHECK (DuracaoContrato > 0),
  DataInicio DATE NOT NULL CHECK(DataInicio > 1910),
  DataFim DATE NOT NULL CHECK (DataFim > DataInicio)
);

CREATE TABLE SEGURANCA (
  Funcionario_ID INTEGER PRIMARY KEY REFERENCES FUNCIONARIO
);

CREATE TABLE OPLIMPEZA (
  Funcionario_ID INTEGER PRIMARY KEY REFERENCES FUNCIONARIO
);

CREATE TABLE OPCAIXA (
  Funcionario_ID INTEGER PRIMARY KEY REFERENCES FUNCIONARIO
);

CREATE TABLE GERENTE (
  Funcionario_ID INTEGER PRIMARY KEY REFERENCES FUNCIONARIO
);

CREATE TABLE LOJA (
  Endereço TEXT(70) PRIMARY KEY,
  Localidade TEXT(50) NOT NULL,
  Telefone TEXT(14) NOT NULL, --Talvez por como PK?
  Horario TEXT(70) NOT NULL,
  Gestor_ID INTEGER NOT NULL REFERENCES GESTOR
);

CREATE TABLE TRABALHAEM (
  Funcionario_ID INTEGER REFERENCES FUNCIONARIO,
  Loja_Endereço TEXT (70) REFERENCES LOJA,
  PRIMARY KEY(Funcionario_ID, Loja_Endereço)
);

CREATE TABLE COMPRAEM (
  Cliente_ID INTEGER REFERENCES CLIENTE,
  Loja_Endereço TEXT (70) REFERENCES LOJA,
  PRIMARY KEY(Cliente_ID, Loja_Endereço)
);

CREATE TABLE PRODUTO (
  ID INTEGER PRIMARY KEY,
  Preco REAL NOT NULL CHECK(Preco > 0),
  QuantidadeProduto INTEGER DEFAULT 0 CHECK (QuantidadeProduto > -1),
  Nome TEXT(70) NOT NULL,
  TipoProduto_ID INTEGER NOT NULL REFERENCES TIPOPRODUTO,
  Compra_ID INTEGER REFERENCES COMPRA
);

CREATE TABLE TIPOPRODUTO (
  ID INTEGER PRIMARY KEY,
  Nome TEXT NOT NULL,
  CodigoBarras TEXT(50) NOT NULL,
  DataValidade DATE NOT NULL,
  Fornecedor_Nome TEXT NOT NULL REFERENCES FORNECEDOR
);

CREATE TABLE DESCONTO (
  ID INTEGER PRIMARY KEY,
  Percentage REAL NOT NULL CHECK(Percentage > 0 and Percentage < 100),
  DataInicio DATE NOT NULL CHECK(DataInicio > 1910),
  DataFim DATE NOT NULL CHECK (DataFim > DataInicio),
  Loja_Endereço TEXT (70) REFERENCES LOJA,
  TipoProduto_ID INTEGER REFERENCES TIPOPRODUTO
);

CREATE TABLE COMPRA (
  ID INTEGER PRIMARY KEY,
  PrecoTotal REAL NOT NULL CHECK (PrecoTotal > 0),
  DataCompra DATE NOT NULL,
  TipoPagamento TEXT(20) NOT NULL CHECK(TipoPagamento = "Multibanco" or TipoPagamento = "Dinheiro"),
  DataEntrega DATE CHECK (DataCompra < DataEntrega),
  LocalEntrega TEXT(70),
  Cliente_ID INTEGER NOT NULL REFERENCES CLIENTE
);

CREATE TABLE ADQUIRE (
  Cliente_ID INTEGER REFERENCES CLIENTE,
  Compra_ID INTEGER REFERENCES COMPRA,
  PRIMARY KEY(Cliente_ID, Compra_ID)
);

CREATE TABLE FORNECEDOR (
  Nome TEXT PRIMARY KEY,
  Endereço TEXT(70) NOT NULL,
  Email TEXT(70) NOT NULL,
  Telefone TEXT(13) NOT NULL
);

CREATE TABLE CENTRODISTRIBUICAO (
  ID INTEGER PRIMARY KEY,
  Localizacao TEXT(70) NOT NULL,
  Horario TEXT(70) NOT NULL
);

CREATE TABLE DISTRIBUI (
  Centro_DistribuicaoID INTEGER REFERENCES CENTRODISTRIBUICAO,
  TipoProduto_ID INTEGER REFERENCES TIPOPRODUTO,
  PRIMARY KEY(Centro_DistribuicaoID, TipoProduto_ID)
);

CREATE TABLE EFORNECIDA (
  Centro_DistribuicaoID INTEGER REFERENCES CENTRODISTRIBUICAO,
  Loja_Endereço TEXT (70) REFERENCES LOJA,
  PRIMARY KEY(Centro_DistribuicaoID, Loja_Endereço)
);

CREATE TABLE FORNECEPRODUTOS (
  Fornecedor_Nome TEXT NOT NULL REFERENCES FORNECEDOR,
  Centro_DistribuicaoID INTEGER REFERENCES CENTRODISTRIBUICAO,
  PRIMARY KEY(Fornecedor_Nome, Centro_DistribuicaoID)
);

CREATE TABLE VENDAS (
  TipoProduto_ID INTEGER NOT NULL REFERENCES TIPOPRODUTO,
  Loja_Endereço TEXT NOT NULL REFERENCES LOJA,
  Lucro REAL NOT NULL,
  QuantidadeVendida INTEGER NOT NULL CHECK(QuantidadeVendida > -1),
  Data DATE NOT NULL,
  PRIMARY KEY(TipoProduto_ID, Loja_Endereço)
);
